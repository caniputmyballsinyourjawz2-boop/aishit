@page "/quiz"
@using Aishit.Models
@using Aishit.Services
@using Microsoft.AspNetCore.Components.Forms
@inject IAIService AIService
@inject IFileProcessingService FileProcessor
@rendermode InteractiveServer

<PageTitle>Multiple Choice Quiz</PageTitle>

<!-- Quiz Info Header -->
<div class="quiz-info">
    <div class="book-icon">üìö</div>
    <div class="quiz-details">
        <h2>Quiz 1</h2>
        <p class="subject">Human psychology 101</p>
        <p class="source">Practice Workbook 1</p>
        <p class="chapter">Chapter 1/ page 5</p>
    </div>
</div>

<div class="divider"></div>

<!-- Upload Section -->
<div class="upload-card">
    <h3>Upload File or Enter Text</h3>
    
    <div class="upload-zone" @onclick="() => fileInput?.Click()">
        <div class="upload-icon">üì§</div>
        <p class="upload-text">Click to upload or drag and drop</p>
        <p class="upload-hint">PDF, DOCX, TXT (Max 50MB)</p>
        <InputFile @ref="fileInput" OnChange="HandleFileSelected" accept=".txt,.pdf,.docx" style="display:none" disabled="@isProcessing" />
    </div>

    @if (isUploadingFile)
    {
        <div class="alert alert-info">
            <span class="spinner">‚è≥</span>
            Processing file: @uploadedFileName
        </div>
    }

    <div class="or-divider">- OR -</div>

    <textarea class="text-input" 
              rows="8" 
              @bind="inputText"
              placeholder="Paste your text here..."
              disabled="@isProcessing"></textarea>
    
    <div class="text-info">
        <small>Character count: @inputText.Length</small>
        <button class="btn-sample" @onclick="LoadSampleText" disabled="@isProcessing">
            Load Sample Text
        </button>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button class="btn btn-primary" @onclick="GenerateQuiz" disabled="@(string.IsNullOrWhiteSpace(inputText) || isProcessing)">
            @if (isProcessing && currentAction == "quiz")
            {
                <span class="spinner">‚è≥</span>
            }
            üìù Generate Quiz
        </button>
        <button class="btn btn-secondary" @onclick="Clear" disabled="@isProcessing">
            üóëÔ∏è Clear All
        </button>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">
            <strong>Error:</strong> @errorMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success">
            ‚úÖ @successMessage
        </div>
    }
</div>

<!-- Quiz Display -->
@if (quizQuestions?.Any() == true)
{
    <div class="quiz-container">
        <div class="quiz-header">
            <h3>üìù Multiple Choice Questions (@quizQuestions.Count Questions)</h3>
            @if (quizSubmitted)
            {
                var score = CalculateScore();
                <p class="score">Score: @score.correct / @quizQuestions.Count (@score.percentage.ToString("F0")%)</p>
            }
        </div>

        <div class="questions-area">
            @foreach (var (question, qIndex) in quizQuestions.Where(q => q.Type == QuestionType.MultipleChoice).Select((q, i) => (q, i)))
            {
                var isCorrect = quizSubmitted && IsAnswerCorrect(qIndex, question);
                <div class="question-card @(quizSubmitted ? (isCorrect ? "correct" : "incorrect") : "")">
                    <div class="question-header">
                        <h6>Question @(qIndex + 1):</h6>
                    </div>
                    <p class="question-text">@question.Question</p>
                    
                    <div class="options">
                        @foreach (var (option, oIndex) in question.Options.Select((o, i) => (o, i)))
                        {
                            var optionIdxStr = oIndex.ToString();
                            var isSelected = selectedAnswers.ContainsKey(qIndex) && selectedAnswers[qIndex] == optionIdxStr;
                            var isCorrectOption = oIndex == question.CorrectIndex;
                            
                            <div class="option @(isSelected ? "selected" : "") @(quizSubmitted && isCorrectOption ? "correct-option" : "")">
                                <input type="radio" 
                                       name="question_@qIndex" 
                                       id="q@(qIndex)_o@(oIndex)"
                                       disabled="@quizSubmitted"
                                       checked="@isSelected"
                                       @onchange="() => SelectAnswer(qIndex, optionIdxStr)" />
                                <label for="q@(qIndex)_o@(oIndex)">
                                    @option
                                    @if (quizSubmitted && isCorrectOption)
                                    {
                                        <span class="badge-correct">‚úì Correct</span>
                                    }
                                </label>
                            </div>
                        }
                    </div>
                    
                    @if (quizSubmitted)
                    {
                        <div class="explanation @(isCorrect ? "correct-exp" : "incorrect-exp")">
                            @if (isCorrect)
                            {
                                <strong>‚úì Correct!</strong>
                            }
                            else
                            {
                                <strong>‚úó Incorrect</strong>
                            }
                            <br />
                            <strong>Explanation:</strong> @question.Explanation
                        </div>
                    }
                </div>
            }
        </div>

        <div class="quiz-actions">
            @if (!quizSubmitted)
            {
                <button class="btn btn-submit" @onclick="SubmitQuiz" disabled="@(selectedAnswers.Count != quizQuestions.Where(q => q.Type == QuestionType.MultipleChoice).Count())">
                    Submit Quiz (@selectedAnswers.Count/@quizQuestions.Where(q => q.Type == QuestionType.MultipleChoice).Count() answered)
                </button>
            }
            else
            {
                <button class="btn btn-retake" @onclick="ResetQuiz">
                    üîÑ Retake Quiz
                </button>
            }
        </div>
    </div>
}

<style>
    /* Quiz Info */
    .quiz-info {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .book-icon {
        width: 70px;
        height: 106px;
        background: #364CFF;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
    }

    .quiz-details h2 {
        color: #7B9CE9;
        font-size: 20px;
        margin: 0 0 8px 0;
    }

    .quiz-details p {
        color: white;
        margin: 0;
        font-size: 14px;
    }

    .subject {
        font-size: 16px !important;
        margin-bottom: 5px !important;
    }

    .divider {
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
        margin: 30px 0;
    }

    /* Upload Card */
    .upload-card {
        background: rgba(5, 5, 5, 0.4);
        border-radius: 10px;
        padding: 30px;
        margin-bottom: 30px;
    }

    .upload-card h3 {
        color: white;
        font-size: 24px;
        margin-bottom: 20px;
    }

    .upload-zone {
        border: 2px dashed #364CFF;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 20px;
    }

    .upload-zone:hover {
        border-color: #2E6FFF;
        background: rgba(46, 111, 255, 0.05);
    }

    .upload-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }

    .upload-text {
        color: white;
        font-size: 16px;
        margin: 0 0 8px 0;
    }

    .upload-hint {
        color: #7B9CE9;
        font-size: 14px;
        margin: 0;
    }

    .or-divider {
        text-align: center;
        color: white;
        font-size: 16px;
        font-weight: bold;
        margin: 20px 0;
    }

    .text-input {
        width: 100%;
        min-height: 200px;
        background: rgba(11, 21, 102, 0.3);
        border: 1px solid #364CFF;
        border-radius: 10px;
        padding: 15px;
        color: white;
        font-size: 14px;
        resize: vertical;
        font-family: inherit;
    }

    .text-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
    }

    .text-info small {
        color: #7B9CE9;
    }

    .btn-sample {
        padding: 8px 16px;
        background: transparent;
        border: 1px solid #364CFF;
        border-radius: 5px;
        color: #7B9CE9;
        cursor: pointer;
        font-size: 14px;
    }

    .btn-sample:hover {
        background: rgba(54, 76, 255, 0.2);
    }

    .action-buttons {
        display: flex;
        gap: 15px;
        margin-top: 20px;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .btn-primary {
        background: #2E6FFF;
        color: white;
    }

    .btn-primary:hover {
        background: #1E5FEF;
        transform: translateY(-2px);
    }

    .btn-secondary {
        background: #757575;
        color: white;
    }

    .btn-secondary:hover {
        background: #656565;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Quiz Container */
    .quiz-container {
        background: rgba(23, 32, 108, 0.4);
        border-radius: 10px;
        padding: 30px;
        margin-top: 30px;
    }

    .quiz-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .quiz-header h3 {
        color: white;
        font-size: 24px;
        margin: 0;
    }

    .score {
        color: #7B9CE9;
        font-size: 18px;
        margin: 0;
    }

    .questions-area {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .question-card {
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid transparent;
        border-radius: 10px;
        padding: 25px;
        transition: all 0.3s;
    }

    .question-card.correct {
        border-color: #4CAF50;
    }

    .question-card.incorrect {
        border-color: #F44336;
    }

    .question-header h6 {
        color: #7B9CE9;
        font-size: 16px;
        margin: 0 0 10px 0;
    }

    .question-text {
        color: white;
        font-size: 20px;
        font-weight: bold;
        margin: 0 0 20px 0;
    }

    .options {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .option {
        background: rgba(11, 21, 102, 0.3);
        border: 2px solid #364CFF;
        border-radius: 8px;
        padding: 15px;
        transition: all 0.3s;
        cursor: pointer;
    }

    .option:hover {
        background: rgba(46, 111, 255, 0.2);
    }

    .option.selected {
        border-color: #2E6FFF;
        background: rgba(46, 111, 255, 0.3);
    }

    .option.correct-option {
        border-color: #4CAF50;
        background: rgba(76, 175, 80, 0.2);
    }

    .option input[type="radio"] {
        margin-right: 10px;
    }

    .option label {
        color: white;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .badge-correct {
        background: #4CAF50;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: bold;
    }

    .explanation {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
    }

    .correct-exp {
        background: rgba(76, 175, 80, 0.2);
        border: 1px solid #4CAF50;
        color: #A5D6A7;
    }

    .incorrect-exp {
        background: rgba(244, 67, 54, 0.2);
        border: 1px solid #F44336;
        color: #EF9A9A;
    }

    .quiz-actions {
        margin-top: 30px;
        text-align: center;
    }

    .btn-submit, .btn-retake {
        padding: 15px 50px;
        background: linear-gradient(180deg, #0B1566 16%, #2E6CFF 92%);
        border: none;
        border-top: 2px solid #364CFF;
        border-radius: 10px;
        color: white;
        font-size: 24px;
        font-style: italic;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.25);
    }

    .btn-submit:hover, .btn-retake:hover {
        background: linear-gradient(180deg, #1B2576 16%, #3E7DFF 92%);
    }

    .alert {
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
    }

    .alert-info {
        background: rgba(33, 150, 243, 0.2);
        border: 1px solid #2196F3;
        color: #90CAF9;
    }

    .alert-danger {
        background: rgba(244, 67, 54, 0.2);
        border: 1px solid #F44336;
        color: #EF9A9A;
    }

    .alert-success {
        background: rgba(76, 175, 80, 0.2);
        border: 1px solid #4CAF50;
        color: #A5D6A7;
    }

    .spinner {
        display: inline-block;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>

@code {
    private InputFile? fileInput;
    private string inputText = "";
    private List<QuizQuestion>? quizQuestions;
    private Dictionary<int, string> selectedAnswers = new();
    private bool quizSubmitted = false;
    private bool isProcessing = false;
    private bool isUploadingFile = false;
    private string errorMessage = "";
    private string successMessage = "";
    private string uploadedFileName = "";
    private string currentAction = "";
    private const long MaxFileSize = 50 * 1024 * 1024;

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        errorMessage = "";
        successMessage = "";
        isUploadingFile = true;
        
        try
        {
            var file = e.File;
            uploadedFileName = file.Name;
            
            if (file.Size > MaxFileSize)
            {
                errorMessage = $"File is too large. Maximum size is 50MB.";
                return;
            }
            
            using var stream = file.OpenReadStream(MaxFileSize);
            inputText = await FileProcessor.ExtractTextFromFileAsync(stream, file.Name);
            successMessage = $"Successfully loaded {inputText.Length} characters";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isUploadingFile = false;
        }
    }

    private async Task GenerateQuiz()
    {
        isProcessing = true;
        currentAction = "quiz";
        errorMessage = "";
        successMessage = "";
        quizQuestions = null;
        ResetQuiz();
        
        try
        {
            quizQuestions = await AIService.GenerateQuizAsync(inputText, 12);
            successMessage = $"Generated {quizQuestions.Count} questions!";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void SelectAnswer(int questionIndex, string answer)
    {
        if (!quizSubmitted)
        {
            selectedAnswers[questionIndex] = answer;
        }
    }

    private bool IsAnswerCorrect(int questionIndex, QuizQuestion question)
    {
        if (!selectedAnswers.ContainsKey(questionIndex))
            return false;
            
        var userAnswer = selectedAnswers[questionIndex];
        return int.TryParse(userAnswer, out int answerIndex) && answerIndex == question.CorrectIndex;
    }

    private (int correct, double percentage) CalculateScore()
    {
        if (quizQuestions == null) return (0, 0);
        
        var mcQuestions = quizQuestions.Where(q => q.Type == QuestionType.MultipleChoice).ToList();
        int correct = 0;
        
        for (int i = 0; i < mcQuestions.Count; i++)
        {
            if (IsAnswerCorrect(i, mcQuestions[i]))
                correct++;
        }
        
        double percentage = mcQuestions.Count > 0 ? (double)correct / mcQuestions.Count * 100 : 0;
        return (correct, percentage);
    }

    private void SubmitQuiz() => quizSubmitted = true;
    private void ResetQuiz()
    {
        selectedAnswers.Clear();
        quizSubmitted = false;
    }

    private void Clear()
    {
        inputText = "";
        quizQuestions = null;
        errorMessage = "";
        successMessage = "";
        uploadedFileName = "";
        ResetQuiz();
    }

    private void LoadSampleText()
    {
        inputText = "Artificial intelligence (AI) is transforming how we live and work. Machine learning algorithms can now analyze vast amounts of data to identify patterns and make predictions. Deep learning uses neural networks with multiple layers to process complex information.";
    }
}